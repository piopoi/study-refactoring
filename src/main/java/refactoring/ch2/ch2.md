# Chapter 02. 리팩터링 원칙

## 2.1 리팩터링 정의

- 리팩터링: [명사] 소프트웨어의 겉보기 동작은 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법.
- 리팩터링하다: [동사] 소프트웨어의 겉보기 동작은 그대로 유지한 채, 여러가지 리팩터링 기법을 적용해서 소프트웨어를 재구성하다.
- 동작을 보존하는 작은 단계들을 거쳐 코드를 수정하고, 이러한 단계들을 순차적으로 연결하여 큰 변화를 만들어내는 일.
- 리팩터링하는 동안에는 코드가 항상 정상 작 동하기 때문에 전체 작업이 끝나지 않았더라도 언제든 멈출 수 있다.
- 리팩터링하다가 프로그램이 정상작동하지 않는다 -> 제대로 된 리팩터링을 한 것이 아니다.
- 저자는 코드베이스를 정리하거나 구조를 바꾸는 모든 작업을 재구성(restructuring)이라는 포괄적인 용어로 표현하고, 리팩터링은 재구성 중 특수한 한 형태로 본다.
- 디버깅하는 데 시간을 빼앗기지 않기 때문에 하나의 큰 작업을 수많은 단계로 잘게 나누는게 더 빠를 수 있다.
- 겉보기 동작(observable behavior)이라는 표현은 사용자 관점에서 리팩터링 전/후에 동작이 같아야 한다는 뜻을 표현한 것이다.
- 리팩터링과 성능 최적화는 비슷해 보이지만 목적이 다르다.
  - 리팩터링: 코드를 이해하고 수정하기 쉽게 만드는 것.
  - 성능 최적화: 오로지 속도 개선.

## 2.2 두 개의 모자

- 저자는 소프트웨어의 개발 목적을 2가지로 구분한다.
  - 기능 추가 vs 리팩터링
    - 기능 추가: 기존 코드는 건드리지 않고 새 기능을 추가하기만 한다.
    - 리팩터링: 코드 재구성에만 전념하고, 기능이나 테스트를 추가 하지 않는다.
- 두 가지 구분의 미묘한 작업 방식의 차이를 인식해야 한다.
- 두 개의 모자(two hats)는 켄트 벡이 한 비유다.

## 2.3 리팩터링하는 이유

- 리팩터링은 소프트웨어를 건강한 상태로 유지하기 위해 도와주는 약이다.

### 리팩터링하면 소프트웨어 설계가 좋아진다.

- 리팩터링을 하지 않으면 소프트웨어의 아키텍처가 부패하고, 코드 구조가 무너지면서 유지보수가 어려워진다.
- 설계가 나쁘면 코드가 길어지고 중복이 많아져 수정과 이해가 복잡해진다.
- 코드량을 줄인다고 속도가 반드시 향상되는 것은 아니지만, 유지보수성과 가독성이 크게 개선된다.
- 중복 코드를 제거하면 모든 코드가 고유한 역할을 수행하게 되며, 이는 바람직한 설계의 핵심이다.

### 리팩터링하면 소프트웨어를 이해하기 쉬워진다.

- 내 소스 코드는 컴퓨터만 사용하는 게 아니라 다른 사람도 사용한다.
- 리팩터링으로 코드의 목적이 더 잘 드러나게 개선할 수 있다.
- 꾸준한 리팩터링으로 내 코드를 사용할 개발자(나 포함)를 배려하자.

### 리팩터링하면 버그를 쉽게 찾을 수 있다.

- 코드를 이해하기 쉽다 = 버그를 찾기 쉽다
- 리팩터링하면 특정 코드가 하는 일이 더욱 명확해지고, 이로 인해 버그를 쉽게 찾을 수 있게 된다.

### 리팩터링하면 프로그래밍 속도를 높일 수 있다.

- 설계 지구력 가설(Design Stamina Hypothesis): 소프트웨어의 내부 설계 품질이 높을수록 이후 기능 추가, 디버깅 등 프로그래밍에 들어가는 시간이 줄어든다.
  - 저자가 실제 증명까지는 못하기 때문에 가설이라고 한다.

## 2.4 언제 리팩터링해야 할까?

- 3의 법칙 by 돈 로버츠(Don Roberts)
  1. 처음에는 그냥 한다.
  2. 비슷한 일을 두번째로 하게 되어도, 일단 계속 진행한다.
  3. 비슷한 일을 세 번째 하게 되면 리팩터링한다.

### 준비를 위한 리팩터링(Preparatory Refactoring): 기능을 쉽게 추가하게 만들기

- 리팩터링하기 가장 좋은 시점은 코드베이스에 기능을 새로 추가하기 직전이다.

### 이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들기

- 코드의 의도를 외울생각하지 말고, 코드에 반영해두면 굳이 기억할 필요가 없다.
- 코드를 분석할 때 리팩터링을 해보면, 더 깊은 수준까지 이해하게 된다.

### 쓰레기 줍기 리팩터링(Litter-Pickup Refactoring)

- 간단히 수정할 수 있는 것은 즉시 고치고, 시간이 좀 걸리는 일은 하던 일을 끝내고 나서 처리한다.

### 계획된 리팩터링과 수시로 하는 리팩터링

- 리팩터링 시간을 일정에 따로 잡아두지 않고, 기회가 될 때마다 해야 한다.
- 무언가 수정하려 할 때는 먼저 수정하기 쉽게 정돈하고(단, 만만치 않을 수 있다) 그런 다음 쉽게 수정하자. by 켄트 벡

### 오래 걸리는 리팩터링

- 리팩터링은 코드를 깨트리지 않으므로, 한 번에 리팩터링을 끝내기 보다는 시간이 더 걸리더라도 조금씩 나눠서 진행하자.

### 코드 리뷰에 리팩터링 활용하기

- 리팩터링을 활용하면 개선안을 구체적으로 도출할 수 있다.
- 효과적인 코드 리뷰를 위해 작성자가 참석하는 방식이 좋으며, 짝(pair) 프로그래밍을 활용하면 자연스럽게 코드 품질을 향상시킬 수 있다.
- 이 부분은 공감이 잘 안된다.
  - 일반적인 코드 리뷰와 어떤 점이 다른지 구체적인 예시가 필요하다.

### 관리자에게는 뭐라고 말해야 할까?

- 기술을 모르는 상당수의 관리자와 고객에게는 리팩터링한다고 말하지 말아라.
- 새로운 기능을 빠르게 구현하기 위한 가장 빠른 방법은 리팩터링이다.

### 리팩터링하지 말아야 할 때

- 리팩터링하면 안 되는 상황도 있다.
- 굳이 수정할 필요가 없는 경우.
- 새로 작성하는게 더 쉬운 경우.

## 2.5 리팩터링 시 고려할 문제

### 새 기능 개발 속도 저하

- 개발자 스스로가 상황에 맞는 균형점을 잘 잡아야 한다.
- 리팩터링의 본질은 개발 기간을 단축하고자 하는 것에 있다.

### 코드 소유권

- 코드의 소유권을 팀에 두고, 팀원이라면 누구나 팀이 소유한 코드를 수정할 수 있게 하자. (다른 사람이 작성했더라도)

### 브랜치

- 머지와 통합을 명확히 구분하자.
  - 머지: 단방향. pull(마스터 -> 브랜치)
  - 통합: 양방향. pull(마스터 -> 브랜치) + push(브랜치 -> 마스터)
- 브랜치 통합 주기를 짧게 관리해야 한다.
  - 지속적 통합(CI, Continuous Integration) or 트렁크 기반 개발(TBD, Trunk-Based Development)
    - 지속적 통합(CI, Continuous Integration): 개발자들이 작성한 코드 변경 사항이 빈번하게 통합되고, 자동화된 빌드 및 테스트 과정을 통해 문제를 조기에 발견하려는 개발 방식이다. 이를 통해 통합과 배포의 안정성과 속도를 개선할 수
      있다.
      - CI에 따르면 모든 팀원이 하루에 최소 한 번은 마스터와 통합해야 한다.
    - 트렁크 기반 개발(TBD, Trunk-Based Development): 모든 개발자가 작은 변경 사항을 자주 메인 브랜치(트렁크)에 통합하는 방식으로, 긴-lived 브랜치를 피하여 버전 관리 복잡도를 줄이고 지속적인 배포를 가능하게 한다.
- CI를 적용하려면 기능을 잘개 쪼개고 기능 on/off 토글을 위한 플래그(feature flag)를 적용하여, 미완성 기능이 시스템에 문제를 발생시키지 않게 해야 한다.
- 익스트림 프로그래밍 (XP, eXtreme Programming): 소프트웨어 개발의 품질과 생산성을 높이기 위해 짧은 개발 사이클, 지속적 통합, 페어 프로그래밍, 테스트 중심 개발(TDD) 등의 실천 방식을 사용하는 애자일 방법론 중 하나다. 팀원 간의 협업과
  지속적인 피드백을 통해 변화에 유연하게 대응할 수 있도록 설계되었다.

### 테스팅

- 오류를 재빨리 잡을 수 있어야 리팩토링이 가능하다. -> 테스트 스위트(test suite)가 필요하다.

### 레거시 코드

- 레거시 시스템을 파악하는데 리팩토링이 도움이 된다.
- 하지만 레거시 시스템에는 테스트 코드가 없는 경우가 많아 테스트를 보강해야 한다.
- 쉽게 해결할 방법은 없다.
- 테스트를 추가하기 힘든 시스템이라면, 테스트 없이 리팩토링을 진행하면서(위험하지만) 테스트를 만들 수 있게 해라.

### 데이터베이스

- 진화형 데이터베이스 설계(evolutionary database design)와 데이터베이스 리팩터링
  - 커다란 변경들을 쉽게 조합하고 다룰 수 있는 데이터 마이그레이션 스크립트를 작성하고,
  - 접근 코드와 데이터베이스 스키마에 대한 구조적 변경을 이 스크립트로 처리하게끔 통합해라.
- 이 역시도 커다란 과정을 작은 단계로 나누는 것이 핵심이다.
- 병렬 수정(parallel change): 기존 기능을 유지하면서 새로운 기능을 추가하고, 두 기능이 병행 작동할 수 있도록 점진적으로 변경하는 방식.
- 팽창-수축(expand-contract): 새로운 구조를 추가(팽창)하고 기존 구조를 점진적으로 제거(수축)하여 시스템을 안전하게 전환하는 리팩터링 기법.

## 2.6 리팩터링, 아키텍처, 애그니(YAGNI)

- 리팩토링은 아키텍처 변경을 가능하게 만들어준다.
- 애그니(YAGNI, You Aren't Gonna Need It): 현재 필요하지 않은 기능은 구현하지 말라는 소프트웨어 개발 원칙이다.
  - 내가 실무에서 애그니 원칙과 같은 방식으로 업무를 진행했었다.
- 나도 문제를 더 깊이 이해하게 됐을 때 처리하는 쪽이 훨씬 낫다고 생각한다.
- 진화형 아키텍처는 아키텍처 관련 결정을 시간을 두고 반복해 내릴 수 있다는 장점을 활용하는 패턴과 실천법을 추구한다

## 2.7 리팩터링과 소프트웨어 개발 프로세스

- 익스트림 프로그래밍(XP) = 지속적 통합(CI) + 테스트 코드 + 리팩터링
  - XP는 최초의 애자일 소프트웨어 방법론 중 하나다.
- 테스트 주도 개발(TDD, Test-Driven Development) = 테스트 코드 + 리팩터링
- 리팩터링이 YAGNI의 토대인 동시에, YAGNI로 인해 리팩터링을 더욱 쉽게 할 수 있다. 서로 긍정적인 영향을 준다.
  - 수많은 유연성 메커니즘을 갖춘 시스템보다는 단순한 시스템이 변경하기가 훨씬 쉽다.

## 2.8 리팩터링과 성능

- 하드 리얼타임 시스템을 제외한 소프트웨어를 빠르게 만드는 비결은, 먼저 튜닝하기 쉽게 만들고 나서 원하는 속도가 나게끔 튜닝하는 것이다.
  - 하드 리얼타임(hard real-time) 시스템: 주어진 작업이 반드시 정해진 시간 내에 완료되어야 하는 시스템.
- 빠른 소프트웨어를 작성하는 3가지 방법
  - 시간 예산 분배 방식(time budgeting)
    - 하드 리얼타임 시스템에서 많이 사용.
    - 설계를 여러 컴포넌트로 나눠서 컴포넌트마다 자원(=공수)을 할당한다.
    - 컴포넌트는 할당된 자원 예산을 초과할 수 없다.
    - 엄격한 시간 엄수가 필요하다.
    - 고객사에 솔루션을 납품했던 내 전 직장이 이 방식이었다.
  - 끊임없이 관심을 기울이는 것.
    - 시스템에 대해 잘 알더라도 섣불리 추측하지 말고 성능을 측정 해봐야 한다. 그러면 십중팔구 내가 잘못 알고 있었음을 깨닫게 된다.
  - 코드 전체를 고르게 최적화한다면, 그중 90%의 시간은 낭비다.
    - 일단 성능에 신경쓰지 않고 코드를 다루기 쉽게 만든다.
    - 이후 성능 최적화 단계에서 프로파일러를 이용하여 성능에 큰 영향을 주는 작은 부분을 찾아 집중적으로 개선(리팩토링)한다.
    - 이 과정을 만족하는 성능에 도달할 때까지 반복한다.
- 단기적으로 리팩토링이 성능에 안좋을 수 있지만, 최적화 단계에서 튜닝에 주는 이점이 훨씬 크다.

## 2.9 리팩터링의 유래

## 2.10 리팩터링 자동화

- 인텔리제이나 이클립스와 같은 IDE는 별도의 테스트가 필요 없을 정도의 자동 리팩터링을 지원한다.

---

## 인상깊었던 부분

- 두 개의 모자
  - 기능 추가 vs 리팩터링
  - 두 가지 구분의 미묘한 작업 방식의 차이를 인식해야 한다.
  - 미묘하다는 부분이 매우 공감이 되었다.
- 관리자에게는 뭐라고 말해야 할까?
  - 항상 실무에서 난감한 부분이다.
  - 책에서의 결론은 리팩터링을 감안하여 실제 기능 개발에 필요한 총 시간을 더 늘려서 얘기하라는 것으로 이해된다.

## 이해가 잘 안된 부분

- 코드 리뷰에 리팩터링 활용하기
  - 일반적인 코드 리뷰와 어떤 점이 다른지 구체적인 예시가 떠오르지 않는다.
  - 단순하게 페어 코딩처럼 리뷰하는 코드를 리팩토링한다는 것일까?

## 공감이 잘 안된 부분

- 3의 법칙 by 돈 로버츠(Don Roberts)
  1. 처음에는 그냥 한다.
  2. 비슷한 일을 두 번째로 하게 되어도, 일단 계속 진행한다.
  3. 비슷한 일을 세 번째 하게 되면 리팩터링한다.
- 난 두 번 하면 바로 리팩터링해야 한다고 생각한다.
